---
title: "Mc"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE,
  collapse = TRUE,
  error = TRUE,
  comment = "#>"
)
```

```{r}
library(FLCore)
library(FLXSA)
library(ggplotFL)
library(patchwork)
library(tidyverse)
library(fishvice)
```

### get data

```{r inputs}
rbx <- fishvice::mup_rbx("/u2/reikn/Tac/2022/01-cod/ass/mup/smx", scale = 1000)
fil <- "/u2/reikn/Tac/2022/01-cod/data-raw/Supplementary S3.xlsx"
shits <- readxl::excel_sheets(fil)
mc.smb <- 
  readxl::read_excel(fil, sheet = shits[1]) %>% 
  mutate(sur = "smb")
mc.smh <- 
  readxl::read_excel(fil,
                     sheet = shits[2]) %>% 
  mutate(sur = "smh")
mc <- 
  bind_rows(mc.smb, mc.smh) %>% 
  spread(sur, Mc) %>% 
  mutate(mc = ifelse(is.na(smh), smb, (smb + smh) / 2))
mc <- 
  expand_grid(year = 1985:2022,
              age = 1:14) %>% 
  left_join(mc %>% select(year, age, mc)) %>% 
  mutate(mc = ifelse(year < 1994, 0.2, mc)) %>% 
  arrange(year, age) %>% 
  group_by(year) %>% 
  fill(mc, .direction = "downup") %>% 
  group_by(age) %>% 
  fill(mc) %>% 
  ungroup()
```

### flr setup

```{r xsasetup}
rbx$rby <- rbx$rby %>% filter(year %in% 1985:2021)
rbx$rbya <- rbx$rbya %>% filter(year %in% 1985:2021)
# set maturity and stock weights such that SSB is actually B4+
rbx$rbya <-
  rbx$rbya %>% 
  mutate(mat = replace_na(mat, 0),
         mat = ifelse(age >= 4, 1, 0),
         ssbW = cW,
         ssbW = replace_na(ssbW, 0))
rbx.mc <- rbx
rbx.mc$rbya <-
  rbx.mc$rbya %>% 
  select(-m) %>% 
  left_join(mc %>% rename(m = mc))
# pf and pm set to 0, so "SSB" = B4+ is based on stock in numbers in start of year
fls <- rbx %>% rbx_to_flstock(pf = 0, pm = 0, fage = c(5, 10))
fls.mc <- rbx.mc %>% rbx_to_flstock(pf = 0, pm = 0, fage = c(5, 10))
ind.smb <- rbx_to_flindex(rbx, "U1") %>% trim(year = 1985:2021)
ind.smh <- rbx_to_flindex(rbx, "U2", time = c(10/12, 10.5/12)) %>% trim(year = 1996:2021)
# only spring survey used in paper
ind <- FLIndices(ind.smb)
```

### xsa runs

```{r xsaruns}
# power up to age 5, q estimated for all age groups!
cntr <- FLXSA.control(maxit = 70, rage = 5, qage = 14)
xsa   <- FLXSA(fls, ind, cntr)
xsa.mc <- FLXSA(fls.mc, ind, cntr)
retro.years <- 1998:2021
retro <- tapply(retro.years, 1:length(retro.years), function(x){
  window(fls,end=x)+FLXSA(window(fls, end = x), ind, cntr)
})
names(retro) <- retro.years
retro.mc <- tapply(retro.years, 1:length(retro.years), function(x){
  window(fls.mc,end=x)+FLXSA(window(fls.mc, end = x), ind, cntr)
})
names(retro.mc) <- retro.years
```

### results

```{r result}
lh.retro <- function(ret) {
  bio <- 
    map(ret, computeStock) %>% 
    map(as.data.frame) %>% 
    map(as_tibble) %>% 
    bind_rows(.id = "assyear") %>% 
    mutate(assyear = as.integer(assyear)) %>% 
    ungroup()
  bio.last <- 
    bio %>% 
    filter(assyear == max(assyear)) %>% 
    select(year, bio = data)
  bio %>% 
    left_join(bio.last) %>% 
    mutate(r = log(data / bio))
}
ret <- lh.retro(retro) %>% mutate(run = "02")
ret.mc <- lh.retro(retro.mc) %>% mutate(run = "mc")
```

```{r, fig.height = 7}
res <- bind_rows(ret, ret.mc)
last.point <- 
  res %>% 
  filter(year == assyear)
p1 <- 
  res %>% 
  ggplot(aes(year, data, group = assyear)) +
  geom_line() +
  geom_point(data = last.point, colour = "red") +
  facet_wrap(~ run) +
  labs(x = NULL, y = "B4+")
p2 <- 
  res %>% 
  ggplot(aes(year, r, group = assyear)) +
  geom_line() +
  geom_point(data = last.point,
             colour = "red") +
  facet_wrap(~ run) +
  labs(x = NULL, y = "contemporaneous\n vs current")
p1 + p2 + plot_layout(ncol = 1)
```

```{r}
last.point %>% 
  group_by(run) %>% 
  summarise(mean = mean(r),
            sd = sd(r))
```

### sanity check - mc input

```{r sanitycheck}
m(fls.mc) %>% trim(year = 1993:2021, age = 1:10) %>% round(2)
```
